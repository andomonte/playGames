{"ast":null,"code":"import _regeneratorRuntime from \"E:/src/next/sistemas/idpb-app/node_modules/next/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"E:/src/next/sistemas/idpb-app/node_modules/next/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport aws from 'aws-sdk';\nimport { HttpRequest } from '@aws-sdk/protocol-http';\nimport { S3RequestPresigner } from '@aws-sdk/s3-request-presigner';\nimport { parseUrl } from '@aws-sdk/url-parser';\nimport { Sha256 } from '@aws-crypto/sha256-browser'; // import { Hash } from '@aws-sdk/hash-node';\n\nimport { formatUrl } from '@aws-sdk/util-format-url'; // const randomBytes = promisify(crypto.randomBytes);\n\nvar region = process.env.AWSREGION;\nvar bucketName = 'sistemaidpb';\nvar accessKeyId = process.env.AWSACCESS_KEY;\nvar secretAccessKey = process.env.AWSSECRET_KEY;\naws.config.update({\n  secretAccessKey: process.env.AWSSECRET_KEY,\n  accessKeyId: process.env.AWSACCESS_KEY,\n  region: process.env.AWSREGION\n});\nvar credentials = {\n  accessKeyId: accessKeyId,\n  secretAccessKey: secretAccessKey,\n  signatureVersion: 'v4'\n};\nexport function downloadImgS3(_x) {\n  return _downloadImgS.apply(this, arguments);\n}\n\nfunction _downloadImgS() {\n  _downloadImgS = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(fileName) {\n    var s3ObjectUrl, presigner, uploadURL;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            // const rawBytes = await randomBytes(16);\n            // const imageName = rawBytes.toString('hex');\n            // pergar URL DO bucket\n            // const uploadURL = await s3.getSignedUrlPromise('putObject', params);\n            s3ObjectUrl = parseUrl(\"https://\".concat(bucketName, \".s3.\").concat(region, \".amazonaws.com/\").concat(fileName));\n            presigner = new S3RequestPresigner({\n              credentials: credentials,\n              region: region,\n              //  sha256: Hash.bind(null, 'sha256'), // In Node.js\n              sha256: Sha256 // In browsers\n\n            }); // Create a GET request from S3 url.\n\n            _context.next = 4;\n            return presigner.presign(new HttpRequest(s3ObjectUrl));\n\n          case 4:\n            uploadURL = _context.sent;\n            console.log('PRESIGNED URL: ', formatUrl(uploadURL)); // pegar a lista do bucket\n\n            /*   const uploadURL = await s3\r\n              .listObjectsV2({\r\n                Bucket: bucketName,\r\n              })\r\n              .promise();\r\n            */\n\n            return _context.abrupt(\"return\", uploadURL);\n\n          case 7:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n  return _downloadImgS.apply(this, arguments);\n}\n\nexport default downloadImgS3;","map":{"version":3,"sources":["E:/src/next/sistemas/idpb-app/src/utils/downloadImgS3.js"],"names":["aws","HttpRequest","S3RequestPresigner","parseUrl","Sha256","formatUrl","region","process","env","AWSREGION","bucketName","accessKeyId","AWSACCESS_KEY","secretAccessKey","AWSSECRET_KEY","config","update","credentials","signatureVersion","downloadImgS3","fileName","s3ObjectUrl","presigner","sha256","presign","uploadURL","console","log"],"mappings":";;AAAA,OAAOA,GAAP,MAAgB,SAAhB;AAEA,SAASC,WAAT,QAA4B,wBAA5B;AACA,SAASC,kBAAT,QAAmC,+BAAnC;AACA,SAASC,QAAT,QAAyB,qBAAzB;AACA,SAASC,MAAT,QAAuB,4BAAvB,C,CACA;;AACA,SAASC,SAAT,QAA0B,0BAA1B,C,CAEA;;AAEA,IAAMC,MAAM,GAAGC,OAAO,CAACC,GAAR,CAAYC,SAA3B;AACA,IAAMC,UAAU,GAAG,aAAnB;AACA,IAAMC,WAAW,GAAGJ,OAAO,CAACC,GAAR,CAAYI,aAAhC;AACA,IAAMC,eAAe,GAAGN,OAAO,CAACC,GAAR,CAAYM,aAApC;AAEAd,GAAG,CAACe,MAAJ,CAAWC,MAAX,CAAkB;AAChBH,EAAAA,eAAe,EAAEN,OAAO,CAACC,GAAR,CAAYM,aADb;AAEhBH,EAAAA,WAAW,EAAEJ,OAAO,CAACC,GAAR,CAAYI,aAFT;AAGhBN,EAAAA,MAAM,EAAEC,OAAO,CAACC,GAAR,CAAYC;AAHJ,CAAlB;AAMA,IAAMQ,WAAW,GAAG;AAClBN,EAAAA,WAAW,EAAXA,WADkB;AAElBE,EAAAA,eAAe,EAAfA,eAFkB;AAGlBK,EAAAA,gBAAgB,EAAE;AAHA,CAApB;AAMA,gBAAsBC,aAAtB;AAAA;AAAA;;;2EAAO,iBAA6BC,QAA7B;AAAA;AAAA;AAAA;AAAA;AAAA;AACL;AACA;AAEA;AACA;AAEMC,YAAAA,WAPD,GAOelB,QAAQ,mBACfO,UADe,iBACEJ,MADF,4BAC0Bc,QAD1B,EAPvB;AAUCE,YAAAA,SAVD,GAUa,IAAIpB,kBAAJ,CAAuB;AACvCe,cAAAA,WAAW,EAAXA,WADuC;AAEvCX,cAAAA,MAAM,EAANA,MAFuC;AAGvC;AACAiB,cAAAA,MAAM,EAAEnB,MAJ+B,CAIvB;;AAJuB,aAAvB,CAVb,EAgBL;;AAhBK;AAAA,mBAiBmBkB,SAAS,CAACE,OAAV,CAAkB,IAAIvB,WAAJ,CAAgBoB,WAAhB,CAAlB,CAjBnB;;AAAA;AAiBCI,YAAAA,SAjBD;AAmBLC,YAAAA,OAAO,CAACC,GAAR,CAAY,iBAAZ,EAA+BtB,SAAS,CAACoB,SAAD,CAAxC,EAnBK,CAqBL;;AACA;AACF;AACA;AACA;AACA;AACA;;AA3BO,6CA2BIA,SA3BJ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AA8BP,eAAeN,aAAf","sourcesContent":["import aws from 'aws-sdk';\r\n\r\nimport { HttpRequest } from '@aws-sdk/protocol-http';\r\nimport { S3RequestPresigner } from '@aws-sdk/s3-request-presigner';\r\nimport { parseUrl } from '@aws-sdk/url-parser';\r\nimport { Sha256 } from '@aws-crypto/sha256-browser';\r\n// import { Hash } from '@aws-sdk/hash-node';\r\nimport { formatUrl } from '@aws-sdk/util-format-url';\r\n\r\n// const randomBytes = promisify(crypto.randomBytes);\r\n\r\nconst region = process.env.AWSREGION;\r\nconst bucketName = 'sistemaidpb';\r\nconst accessKeyId = process.env.AWSACCESS_KEY;\r\nconst secretAccessKey = process.env.AWSSECRET_KEY;\r\n\r\naws.config.update({\r\n  secretAccessKey: process.env.AWSSECRET_KEY,\r\n  accessKeyId: process.env.AWSACCESS_KEY,\r\n  region: process.env.AWSREGION,\r\n});\r\n\r\nconst credentials = {\r\n  accessKeyId,\r\n  secretAccessKey,\r\n  signatureVersion: 'v4',\r\n};\r\n\r\nexport async function downloadImgS3(fileName) {\r\n  // const rawBytes = await randomBytes(16);\r\n  // const imageName = rawBytes.toString('hex');\r\n\r\n  // pergar URL DO bucket\r\n  // const uploadURL = await s3.getSignedUrlPromise('putObject', params);\r\n\r\n  const s3ObjectUrl = parseUrl(\r\n    `https://${bucketName}.s3.${region}.amazonaws.com/${fileName}`,\r\n  );\r\n  const presigner = new S3RequestPresigner({\r\n    credentials,\r\n    region,\r\n    //  sha256: Hash.bind(null, 'sha256'), // In Node.js\r\n    sha256: Sha256, // In browsers\r\n  });\r\n  // Create a GET request from S3 url.\r\n  const uploadURL = await presigner.presign(new HttpRequest(s3ObjectUrl));\r\n\r\n  console.log('PRESIGNED URL: ', formatUrl(uploadURL));\r\n\r\n  // pegar a lista do bucket\r\n  /*   const uploadURL = await s3\r\n    .listObjectsV2({\r\n      Bucket: bucketName,\r\n    })\r\n    .promise();\r\n */ return uploadURL;\r\n}\r\n\r\nexport default downloadImgS3;\r\n"]},"metadata":{},"sourceType":"module"}